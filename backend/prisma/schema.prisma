// Esquema de Base de Datos - SGMI
// Sistema de Gestión de Mantenimiento Industrial

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUARIOS Y ROLES ====================

model Rol {
  id          Int       @id @default(autoincrement())
  nombre      String    @unique @db.VarChar(50)
  descripcion String?   @db.Text
  permisos    Json      // { ordenes: { crear: true, editar: true }, usuarios: { ver: true } }
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  usuarios    Usuario[]

  @@map("roles")
}

model Usuario {
  id              String    @id @default(uuid()) @db.Uuid
  nombre          String    @db.VarChar(100)
  email           String    @unique @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  rolId           Int       @map("rol_id")
  departamento    String?   @db.VarChar(100)
  estado          EstadoUsuario @default(ACTIVO)
  ultimoAcceso    DateTime? @map("ultimo_acceso")
  refreshToken    String?   @map("refresh_token") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  rol             Rol       @relation(fields: [rolId], references: [id])
  ordenesCreadas  OrdenTrabajo[] @relation("OrdenesCreadas")
  ordenesAsignadas OrdenTrabajo[] @relation("OrdenesAsignadas")
  novedades       Novedad[]

  @@map("usuarios")
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

// ==================== ÓRDENES DE TRABAJO ====================

model OrdenTrabajo {
  id                  String    @id @db.VarChar(20) // OT-001, OT-002, etc.
  equipo              String    @db.VarChar(100)
  tipo                TipoOrden
  prioridad           Prioridad
  estado              EstadoOrden @default(PENDIENTE)
  descripcion         String?   @db.Text
  tecnicoAsignadoId   String?   @map("tecnico_asignado_id") @db.Uuid
  progreso            Int       @default(0) // 0-100
  fechaInicio         DateTime? @map("fecha_inicio")
  fechaFin            DateTime? @map("fecha_fin")
  creadoPorId         String    @map("creado_por_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  tecnicoAsignado     Usuario?  @relation("OrdenesAsignadas", fields: [tecnicoAsignadoId], references: [id])
  creadoPor           Usuario   @relation("OrdenesCreadas", fields: [creadoPorId], references: [id])
  novedades           Novedad[]

  @@map("ordenes_trabajo")
}

enum TipoOrden {
  PREVENTIVO
  CORRECTIVO
  PREDICTIVO
}

enum Prioridad {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum EstadoOrden {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
  CANCELADA
}

// ==================== NOVEDADES E IMPEDIMENTOS ====================

model Novedad {
  id              Int       @id @default(autoincrement())
  ordenTrabajoId  String    @map("orden_trabajo_id") @db.VarChar(20)
  tipo            String    @db.VarChar(50)
  impedimento     String    @db.Text
  severidad       Severidad
  reportadoPorId  String    @map("reportado_por_id") @db.Uuid
  resuelto        Boolean   @default(false)
  fechaReporte    DateTime  @default(now()) @map("fecha_reporte")
  fechaResolucion DateTime? @map("fecha_resolucion")
  
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)
  reportadoPor    Usuario   @relation(fields: [reportadoPorId], references: [id])

  @@map("novedades")
}

enum Severidad {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

// ==================== INVENTARIO ====================

model ItemInventario {
  id          Int       @id @default(autoincrement())
  nombre      String    @db.VarChar(100)
  codigo      String    @unique @db.VarChar(50)
  categoria   String?   @db.VarChar(50)
  cantidad    Int       @default(0)
  ubicacion   String?   @db.VarChar(100)
  proveedor   String?   @db.VarChar(100)
  stockMinimo Int       @default(0) @map("stock_minimo")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("inventario")
}

// ==================== PROYECTOS/CUENTAS ====================

model Proyecto {
  id          String    @id @db.VarChar(20) // PROJ-001
  nombre      String    @db.VarChar(100)
  cuenta      String    @unique @db.VarChar(50) // SGMI-2025-001
  descripcion String?   @db.Text
  estado      Boolean   @default(true) // Activo/Inactivo
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("proyectos")
}
